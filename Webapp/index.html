<!DOCTYPE html>
<html>
<head>
<meta charset=utf-8 />
<script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
<style>
#container {
  width: 800px;
  margin: 0px auto;
}
video {
  width: 800px;
  height: 600px;
  margin-bottom: 10px;
  background: black;
}
#fullscreen {
  float: right;
}
body {
  margin: 0px;
  background: #111111;
  padding-top: 30px;
}
</style>
<title>Broadcaster</title>
</head>
<body>
  <div id="container">
    <video id="video" autoplay="true" muted="muted"></video>
    <nav id="channel-nav">
      <!-- Channels will be loaded dynamically -->
      <button id="fullscreen">Fullscreen</button>
    </nav>
  </div>
  <script>
    // Load channels dynamically from manifest
    fetch('/manifest.json')
      .then(response => response.json())
      .then(manifest => {
        const nav = document.getElementById('channel-nav');
        const fullscreenButton = document.getElementById('fullscreen');

        manifest.channels.forEach(channel => {
          const button = document.createElement('button');
          button.id = channel.slug;
          button.className = 'channel';
          button.textContent = channel.name;
          nav.insertBefore(button, fullscreenButton);
        });

        // Initialize video player after channels are loaded
        const firstChannel = manifest.channels.length > 0 ? manifest.channels[0].slug : null;
        initializePlayer(firstChannel);
      })
      .catch(err => {
        console.error('Failed to load channels:', err);
        initializePlayer(null);
      });

    function initializePlayer(defaultChannel) {
      if (window.safari && navigator.userAgent.toLowerCase().indexOf('chrome') == -1) {
      var video = document.getElementById('video');
      video.src = defaultChannel ? `/${defaultChannel}.m3u8` : `/channels/static/_.m3u8`;
      document.querySelectorAll('button.channel')
        .forEach((button) => button.addEventListener('click', () => {
          video.src = '#';
          video.style.background = "none";
          video.style.backgroundImage = "black";
          video.addEventListener('timeupdate', () => {
            video.style.background = "black";
            video.style.backgroundImage = "none";
          });
          const channel = button.getAttribute('id');
          video.src = `/${channel}.m3u8`;
        }))
      document.querySelector('button#fullscreen').addEventListener('click', (element) => {
        video.requestFullscreen();
      })
      document.querySelectorAll('*')
        .forEach((el) => el.addEventListener('mouseover', () => {
          video.muted = false;
        }))
    } else {
      var video = document.getElementById('video');
      window.hls = new Hls();
      window.hls.config.liveDurationInfinity = true
      window.hls.loadSource(defaultChannel ? `/${defaultChannel}.m3u8` : `/channels/static/_.m3u8`);
      window.hls.attachMedia(video);

      // Add error handling
      window.hls.on(Hls.Events.ERROR, function(event, data) {
        console.error('HLS error:', data);
        if (data.fatal) {
          switch(data.type) {
            case Hls.ErrorTypes.NETWORK_ERROR:
              console.log('Network error, trying to recover...');
              window.hls.startLoad();
              break;
            case Hls.ErrorTypes.MEDIA_ERROR:
              console.log('Media error, trying to recover...');
              window.hls.recoverMediaError();
              break;
            default:
              console.log('Fatal error, destroying and recreating player...');
              window.hls.destroy();
              window.location.reload();
              break;
          }
        }
      });

      video.addEventListener('click',function() {
        video.muted = false;
      });
      document.querySelectorAll('button.channel')
        .forEach((button) => button.addEventListener('click', () => {
          video.style.background = "none";
          video.style.backgroundImage = "url('static.gif')";
          window.hls.detachMedia(video);
          window.hls = null
          window.hls = new Hls();
          window.hls.config.liveDurationInfinity = true
          window.hls.on(Hls.Events.FRAG_BUFFERED, ()=>{
            video.style.background = "black";
            video.style.backgroundImage = "none";
          });
          const channel = button.getAttribute('id');
          window.hls.loadSource(`/${channel}.m3u8`);
          window.hls.attachMedia(video);
        }))
      document.querySelector('button#fullscreen').addEventListener('click', (element) => {
        video.requestFullscreen();
      })
      document.querySelectorAll('*')
        .forEach((el) => el.addEventListener('mouseover', () => {
          video.muted = false;
        }))
      }
    }
  </script>
</body>
</html>
